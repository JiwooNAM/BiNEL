task_name: train
tags:
- multimodal
- singleprofile
- classification
- scvi_n200
- imagenet_vit_l
- final_test
train: true
test: true
ckpt_path: null
seed: 1
float32_matmul_precision: highest
data:
  _target_: scgenescope.data.modules.LitGenericDataModule
  data_iter_factory:
    train:
      num_populations: 1280000
      resample_factor: 1
      seed: null
      batch_size: ${BATCH_SIZE}
      factory:
        condition: Treatment
        use_multiprocess_loading: false
        _target_: scgenescope.data.datasets.ConditionAlignedPopulations.join_on_condition
        _partial_: true
        rnaseq:
          _target_: scgenescope.data.datasets.SampledPopulation.from_factory
          _partial_: true
          condition_on: Treatment
          indexing: condition
          include_condition: false
          num_samples: 1
          samples_factory:
            include_observations: false
            file_path:
              _target_: scgenescope.data.utils.get_datapath
              path: ${paths.data_dir}
              split: train
              embedding_file_name: round_1.h5ad
              embedding_key: scvi_n200
              omics_embedding: scvi
              omics_revision: n200
              imaging_embedding: null
              imaging_revision: null
              include_seen: true
              include_unseen: true
              batch_select: null
              replicate_select:
              - '3'
              treatment_select:
              - Phenacetin
              - PQ401
              - Splitomicin
              - (R)-MG132
              - (R)-Roscovitine
              - Wy 14643 / Pirinixic Acid
              - Fluocinonide
              - Caffeine
              - LY303511 (hydrochloride)
              - Simvastatin
              - Colchicine
              - Pantoprazole
              - Cycloheximide
              - Benzbromarone
              - Thapsigargin
              - BAY 11-7082
              - CGK-733
              - PD-98059
              - GW-843682X
              - 12-O-tetradecanoylphorbol-13-acetate
              - SKII
              - AMG-900
              - DBeQ
              - Daporinad / FK-866
              - Vorinostat / SAHA
              - Quinidine
              - Aloxistatin / E-64d
              - HARMAN
            _target_: scgenescope.data.datasets.Samples.auto_factory
            _partial_: true
            obs_keys:
            - Treatment
        imaging:
          _target_: scgenescope.data.datasets.SampledPopulation.from_factory
          _partial_: true
          condition_on: Treatment
          indexing: condition
          include_condition: false
          num_samples: 1
          samples_factory:
            include_observations: false
            file_path:
              _target_: scgenescope.data.utils.get_datapath
              path: ${paths.data_dir}
              split: train
              embedding_file_name: round_1.h5ad
              embedding_key: null
              omics_embedding: null
              omics_revision: null
              imaging_embedding: imagenet
              imaging_revision: vit-l
              include_seen: true
              include_unseen: true
              batch_select: null
              replicate_select:
              - '3'
              treatment_select:
              - Phenacetin
              - PQ401
              - Splitomicin
              - (R)-MG132
              - (R)-Roscovitine
              - Wy 14643 / Pirinixic Acid
              - Fluocinonide
              - Caffeine
              - LY303511 (hydrochloride)
              - Simvastatin
              - Colchicine
              - Pantoprazole
              - Cycloheximide
              - Benzbromarone
              - Thapsigargin
              - BAY 11-7082
              - CGK-733
              - PD-98059
              - GW-843682X
              - 12-O-tetradecanoylphorbol-13-acetate
              - SKII
              - AMG-900
              - DBeQ
              - Daporinad / FK-866
              - Vorinostat / SAHA
              - Quinidine
              - Aloxistatin / E-64d
              - HARMAN
            _target_: scgenescope.data.datasets.Samples.auto_factory
            _partial_: true
            obs_keys:
            - Treatment
      _target_: scgenescope.data.datasets.MakeIterable.from_factory
      _partial_: true
    val:
      num_populations: 128000
      resample_factor: 1
      seed: 2024
      batch_size: ${BATCH_SIZE}
      factory:
        condition: Treatment
        use_multiprocess_loading: false
        _target_: scgenescope.data.datasets.ConditionAlignedPopulations.join_on_condition
        _partial_: true
        rnaseq:
          _target_: scgenescope.data.datasets.SampledPopulation.from_factory
          _partial_: true
          condition_on: Treatment
          indexing: condition
          include_condition: false
          num_samples: 1
          samples_factory:
            include_observations: false
            file_path:
              _target_: scgenescope.data.utils.get_datapath
              path: ${paths.data_dir}
              split: val
              embedding_file_name: round_1.h5ad
              embedding_key: scvi_n200
              omics_embedding: scvi
              omics_revision: n200
              imaging_embedding: null
              imaging_revision: null
              include_seen: true
              include_unseen: true
              batch_select: null
              replicate_select:
              - '5'
              treatment_select:
              - Phenacetin
              - PQ401
              - Splitomicin
              - (R)-MG132
              - (R)-Roscovitine
              - Wy 14643 / Pirinixic Acid
              - Fluocinonide
              - Caffeine
              - LY303511 (hydrochloride)
              - Simvastatin
              - Colchicine
              - Pantoprazole
              - Cycloheximide
              - Benzbromarone
              - Thapsigargin
              - CGK-733
              - PD-98059
              - GW-843682X
              - 12-O-tetradecanoylphorbol-13-acetate
              - SKII
              - AMG-900
              - DBeQ
              - Daporinad / FK-866
              - Vorinostat / SAHA
              - Quinidine
              - Aloxistatin / E-64d
              - HARMAN
            _target_: scgenescope.data.datasets.Samples.auto_factory
            _partial_: true
            obs_keys:
            - Treatment
        imaging:
          _target_: scgenescope.data.datasets.SampledPopulation.from_factory
          _partial_: true
          condition_on: Treatment
          indexing: condition
          include_condition: false
          num_samples: 1
          samples_factory:
            include_observations: false
            file_path:
              _target_: scgenescope.data.utils.get_datapath
              path: ${paths.data_dir}
              split: val
              embedding_file_name: round_1.h5ad
              embedding_key: null
              omics_embedding: null
              omics_revision: null
              imaging_embedding: imagenet
              imaging_revision: vit-l
              include_seen: true
              include_unseen: true
              batch_select: null
              replicate_select:
              - '5'
              treatment_select:
              - Phenacetin
              - PQ401
              - Splitomicin
              - (R)-MG132
              - (R)-Roscovitine
              - Wy 14643 / Pirinixic Acid
              - Fluocinonide
              - Caffeine
              - LY303511 (hydrochloride)
              - Simvastatin
              - Colchicine
              - Pantoprazole
              - Cycloheximide
              - Benzbromarone
              - Thapsigargin
              - CGK-733
              - PD-98059
              - GW-843682X
              - 12-O-tetradecanoylphorbol-13-acetate
              - SKII
              - AMG-900
              - DBeQ
              - Daporinad / FK-866
              - Vorinostat / SAHA
              - Quinidine
              - Aloxistatin / E-64d
              - HARMAN
            _target_: scgenescope.data.datasets.Samples.auto_factory
            _partial_: true
            obs_keys:
            - Treatment
      _target_: scgenescope.data.datasets.MakeIterable.from_factory
      _partial_: true
    test:
      num_populations: 128000
      resample_factor: 1
      seed: 2024
      batch_size: ${BATCH_SIZE}
      factory:
        condition: Treatment
        use_multiprocess_loading: false
        _target_: scgenescope.data.datasets.ConditionAlignedPopulations.join_on_condition
        _partial_: true
        rnaseq:
          _target_: scgenescope.data.datasets.SampledPopulation.from_factory
          _partial_: true
          condition_on: Treatment
          indexing: condition
          include_condition: false
          num_samples: 1
          samples_factory:
            include_observations: false
            file_path:
              _target_: scgenescope.data.utils.get_datapath
              path: ${paths.data_dir}
              split: HE_test
              embedding_file_name: round_2.h5ad
              embedding_key: scvi_n200
              omics_embedding: scvi
              omics_revision: n200
              imaging_embedding: null
              imaging_revision: null
              include_seen: true
              include_unseen: true
              batch_select: null
              replicate_select:
              - '1'
              - '2'
              treatment_select:
              - Phenacetin
              - PQ401
              - Splitomicin
              - (R)-MG132
              - (R)-Roscovitine
              - Wy 14643 / Pirinixic Acid
              - Fluocinonide
              - Caffeine
              - LY303511 (hydrochloride)
              - Simvastatin
              - Colchicine
              - Pantoprazole
              - Cycloheximide
              - Benzbromarone
              - Thapsigargin
              - CGK-733
              - PD-98059
              - GW-843682X
              - 12-O-tetradecanoylphorbol-13-acetate
              - SKII
              - AMG-900
              - DBeQ
              - Daporinad / FK-866
              - Vorinostat / SAHA
              - Quinidine
              - Aloxistatin / E-64d
              - HARMAN
            _target_: scgenescope.data.datasets.Samples.auto_factory
            _partial_: true
            obs_keys:
            - Treatment
        imaging:
          _target_: scgenescope.data.datasets.SampledPopulation.from_factory
          _partial_: true
          condition_on: Treatment
          indexing: condition
          include_condition: false
          num_samples: 1
          samples_factory:
            include_observations: false
            file_path:
              _target_: scgenescope.data.utils.get_datapath
              path: ${paths.data_dir}
              split: HE_test
              embedding_file_name: round_2.h5ad
              embedding_key: null
              omics_embedding: null
              omics_revision: null
              imaging_embedding: imagenet
              imaging_revision: vit-l
              include_seen: true
              include_unseen: true
              batch_select: null
              replicate_select:
              - '1'
              - '2'
              treatment_select:
              - Phenacetin
              - PQ401
              - Splitomicin
              - (R)-MG132
              - (R)-Roscovitine
              - Wy 14643 / Pirinixic Acid
              - Fluocinonide
              - Caffeine
              - LY303511 (hydrochloride)
              - Simvastatin
              - Colchicine
              - Pantoprazole
              - Cycloheximide
              - Benzbromarone
              - Thapsigargin
              - CGK-733
              - PD-98059
              - GW-843682X
              - 12-O-tetradecanoylphorbol-13-acetate
              - SKII
              - AMG-900
              - DBeQ
              - Daporinad / FK-866
              - Vorinostat / SAHA
              - Quinidine
              - Aloxistatin / E-64d
              - HARMAN
            _target_: scgenescope.data.datasets.Samples.auto_factory
            _partial_: true
            obs_keys:
            - Treatment
      _target_: scgenescope.data.datasets.MakeIterable.from_factory
      _partial_: true
  transform:
    example_transform:
      condition:
        _target_: scgenescope.transforms.Compose.from_items
        encode:
          _target_: scgenescope.transforms.LabelEncode
          path_to_categories:
            _target_: scgenescope.resources.request_resource
            resource: all_treatments_no_DMSO
        squeeze:
          _target_: scgenescope.transforms.Squeeze
      _target_: scgenescope.transforms.Dispatch
      rnaseq:
        _target_: scgenescope.transforms.Compose.from_items
        tensorize:
          _target_: scgenescope.transforms.ToTensor
          squeeze: true
          dtype: float32
      imaging:
        _target_: scgenescope.transforms.Compose.from_items
        tensorize:
          _target_: scgenescope.transforms.ToTensor
          squeeze: true
          dtype: float32
    _target_: scgenescope.transforms.Batchify
    collate_fn:
      _target_: torch.utils.data.default_collate
      _partial_: true
  loader_factory:
    _target_: scgenescope.data.loaders.NoCollateDataLoader
    _partial_: true
    batch_size: null
    batch_sampler: null
    shuffle: false
    num_workers: ${NUM_WORKERS}
model:
  _target_: scgenescope.models.classification.multimodal.MultiModalMultipleInputClassifier
  classifier:
    _target_: scgenescope.models.nn.mlp.MLP.from_fixed_hidden_dim
    activation_factory:
      _target_: torch.nn.ReLU
      _partial_: true
    normalization: layer
    input_dim: ${multiply:2,${OUTPUT_DIM_PER_MODALITY}}
    output_dim: ${NUM_CLASSES}
    hidden_dim: 4034
    depth: 1
  optimizer_factory:
    _target_: torch.optim.Adam
    _partial_: true
    lr: 0.0005106425781482568
    weight_decay: 0.0032449867218729347
  scheduler_factory:
    _target_: torch.optim.lr_scheduler.ReduceLROnPlateau
    _partial_: true
    mode: min
    factor: 0.1
    patience: 5
  compile: false
  add_normalization: true
  ignore_names: false
  input_dropout:
    rnaseq: 0
    imaging: 0.5
  hidden_dropout: 0.5
  rnaseq:
    _target_: scgenescope.models.nn.mlp.MLP.from_fixed_hidden_dim
    input_dim: ${RNASEQ_INPUT_DIM}
    output_dim: ${OUTPUT_DIM_PER_MODALITY}
    hidden_dim: 3198
    activation_factory:
      _target_: torch.nn.ReLU
      _partial_: true
    normalization: layer
    depth: 3
  imaging:
    _target_: scgenescope.models.nn.mlp.MLP.from_fixed_hidden_dim
    input_dim: ${IMAGING_INPUT_DIM}
    output_dim: ${OUTPUT_DIM_PER_MODALITY}
    hidden_dim: 326
    activation_factory:
      _target_: torch.nn.ReLU
      _partial_: true
    normalization: layer
    depth: 3
callbacks:
  model_summary:
    _target_: lightning.pytorch.callbacks.RichModelSummary
    max_depth: -1
  rich_progress_bar:
    _target_: lightning.pytorch.callbacks.RichProgressBar
  early_stopping:
    _target_: lightning.pytorch.callbacks.EarlyStopping
    monitor: val/acc
    patience: 12
    mode: max
  model_checkpoint:
    _target_: lightning.pytorch.callbacks.ModelCheckpoint
    monitor: val/acc
    dirpath: ${paths.ckpt_dir}
    filename: '{epoch}-{step}'
    every_n_epochs: 1
    mode: max
    save_top_k: 1
  lr_monitor:
    _target_: lightning.pytorch.callbacks.LearningRateMonitor
    log_momentum: true
    logging_interval: epoch
logger:
  tensorboard:
    _target_: lightning.pytorch.loggers.TensorBoardLogger
    save_dir: ${paths.output_dir}
    name: ${concat:${tags}}
    prefix: ''
  csv:
    _target_: lightning.pytorch.loggers.csv_logs.CSVLogger
    save_dir: ${paths.output_dir}
    name: ${concat:${tags}}
    prefix: ''
trainer:
  _target_: lightning.pytorch.trainer.Trainer
  default_root_dir: ${paths.output_dir}
  min_epochs: 2
  max_epochs: 100
  accelerator: gpu
  devices: 1
  check_val_every_n_epoch: 1
  deterministic: false
  gradient_clip_val: 0.5
  log_every_n_steps: 5
paths:
  root_dir: ${oc.env:PROJECT_ROOT,${hydra:runtime.cwd}}
  data_dir: ${paths.root_dir}/data/
  log_dir: ${paths.root_dir}/logs/
  output_dir: ${hydra:runtime.output_dir}
  work_dir: ${hydra:runtime.cwd}
  ckpt_dir: ${hydra:runtime.output_dir}/checkpoints
extras:
  ignore_warnings: false
  enforce_tags: true
  print_config: true
cmd_tag: ''
BATCH_SIZE: 4096
NUM_WORKERS: 8
NUM_CLASSES: 28
RNASEQ_INPUT_DIM: 200
IMAGING_INPUT_DIM: 5120
OUTPUT_DIM_PER_MODALITY: 864
