# @package _global_


defaults:
  # Select rnaseq data sources
  - /data/source/embeddings@data.data_iter_factory.train.factory.rnaseq.samples_factory.file_path: >- 
      rnaseq/n_hvg/n1000/train.yaml
  - /data/source/embeddings@data.data_iter_factory.val.factory.rnaseq.samples_factory.file_path: >-
      rnaseq/n_hvg/n1000/val.yaml
  - /data/source/embeddings@data.data_iter_factory.test.factory.rnaseq.samples_factory.file_path: >-
      rnaseq/n_hvg/n1000/HE_test.yaml
  # Select imaging data sources
  - /data/source/embeddings@data.data_iter_factory.train.factory.imaging.samples_factory.file_path: >-
      imaging/imagenet/vit-l/concat/train.yaml
  - /data/source/embeddings@data.data_iter_factory.val.factory.imaging.samples_factory.file_path: >-
      imaging/imagenet/vit-l/concat/val.yaml
  - /data/source/embeddings@data.data_iter_factory.test.factory.imaging.samples_factory.file_path: >-
      imaging/imagenet/vit-l/concat/HE_test.yaml

  # Select data pipeline
  - override /data: pipeline/multimodal/rna_imaging_multiprofile
  - override /data/pipeline/transform/treatment@data.transform.example_transform.condition: label_encode_all
  # Select model
  - override /model: singleprofile/multiple_input
  # Set up infrastructure parameters

# all parameters below will be merged with parameters from default configurations set above
# this allows you to overwrite only specified parameters

cmd_tag: ""
tags: ["multimodal", "singleprofile", "classification", "hvg_n1000", "imagenet_vit_l", "final_test"]

seed: 12345

# Configurable experiment parameters
BATCH_SIZE: 4096
NUM_WORKERS: 8 
NUM_CLASSES: 28
RNASEQ_INPUT_DIM: 1000
IMAGING_INPUT_DIM: 5120


# some of the hyperparams
OUTPUT_DIM_PER_MODALITY: 864


model:
  classifier:
    input_dim: ${multiply:2,${OUTPUT_DIM_PER_MODALITY}} # 2 modalities * 128
    output_dim: ${NUM_CLASSES}  # number of perturbation classes
    hidden_dim: 4034
    depth: 1
    normalization: layer
    activation_factory:
      _target_: torch.nn.ReLU
      _partial_: true

  add_normalization: true
  ignore_names: false
  compile: false

  input_dropout: 
    rnaseq: 0
    imaging: 0.5
  hidden_dropout: 0.5

  rnaseq:
    _target_: scgenescope.models.nn.mlp.MLP.from_fixed_hidden_dim
    input_dim: ${RNASEQ_INPUT_DIM}
    output_dim: ${OUTPUT_DIM_PER_MODALITY}
    hidden_dim: 3198
    activation_factory:
      _target_: torch.nn.ReLU
      _partial_: true
    normalization: layer
    depth: 3
    
  imaging:
    _target_: scgenescope.models.nn.mlp.MLP.from_fixed_hidden_dim
    input_dim: ${IMAGING_INPUT_DIM}
    output_dim: ${OUTPUT_DIM_PER_MODALITY}
    hidden_dim: 326
    activation_factory:
      _target_: torch.nn.ReLU
      _partial_: true
    normalization: layer
    depth: 3

  optimizer_factory:
    lr: 0.0005106425781482568
    weight_decay: 0.0032449867218729347
  
  scheduler_factory:
    mode: min
    factor: 0.1
    patience: 5

# Set up data pipeline
data:
  data_iter_factory:
    train:
      batch_size: ${BATCH_SIZE}
      factory:
        rnaseq:
          num_samples: 1 
        imaging:
          num_samples: 1 
    val:
      batch_size: ${BATCH_SIZE}
      factory:
        rnaseq:
          num_samples: 1
          samples_factory:
            file_path: 
              treatment_select:
                - Phenacetin
                - PQ401
                - Splitomicin
                - (R)-MG132
                - (R)-Roscovitine
                - Wy 14643 / Pirinixic Acid
                - Fluocinonide
                - Caffeine
                - LY303511 (hydrochloride)
                - Simvastatin
                - Colchicine
                - Pantoprazole
                - Cycloheximide
                - Benzbromarone
                - Thapsigargin
                - CGK-733
                - PD-98059
                - GW-843682X
                - 12-O-tetradecanoylphorbol-13-acetate
                - SKII
                - AMG-900
                - DBeQ
                - Daporinad / FK-866
                - Vorinostat / SAHA
                - Quinidine
                - Aloxistatin / E-64d
                - HARMAN
        imaging:
          num_samples: 1
          samples_factory:
            file_path: 
              treatment_select:
                - Phenacetin
                - PQ401
                - Splitomicin
                - (R)-MG132
                - (R)-Roscovitine
                - Wy 14643 / Pirinixic Acid
                - Fluocinonide
                - Caffeine
                - LY303511 (hydrochloride)
                - Simvastatin
                - Colchicine
                - Pantoprazole
                - Cycloheximide
                - Benzbromarone
                - Thapsigargin
                - CGK-733
                - PD-98059
                - GW-843682X
                - 12-O-tetradecanoylphorbol-13-acetate
                - SKII
                - AMG-900
                - DBeQ
                - Daporinad / FK-866
                - Vorinostat / SAHA
                - Quinidine
                - Aloxistatin / E-64d
                - HARMAN

    test:
      batch_size: ${BATCH_SIZE}
      factory:
        rnaseq:
          num_samples: 1
          samples_factory:
            file_path: 
              treatment_select:
                - Phenacetin
                - PQ401
                - Splitomicin
                - (R)-MG132
                - (R)-Roscovitine
                - Wy 14643 / Pirinixic Acid
                - Fluocinonide
                - Caffeine
                - LY303511 (hydrochloride)
                - Simvastatin
                - Colchicine
                - Pantoprazole
                - Cycloheximide
                - Benzbromarone
                - Thapsigargin
                - CGK-733
                - PD-98059
                - GW-843682X
                - 12-O-tetradecanoylphorbol-13-acetate
                - SKII
                - AMG-900
                - DBeQ
                - Daporinad / FK-866
                - Vorinostat / SAHA
                - Quinidine
                - Aloxistatin / E-64d
                - HARMAN
        imaging:
          num_samples: 1
          samples_factory:
            file_path: 
              treatment_select:
                - Phenacetin
                - PQ401
                - Splitomicin
                - (R)-MG132
                - (R)-Roscovitine
                - Wy 14643 / Pirinixic Acid
                - Fluocinonide
                - Caffeine
                - LY303511 (hydrochloride)
                - Simvastatin
                - Colchicine
                - Pantoprazole
                - Cycloheximide
                - Benzbromarone
                - Thapsigargin
                - CGK-733
                - PD-98059
                - GW-843682X
                - 12-O-tetradecanoylphorbol-13-acetate
                - SKII
                - AMG-900
                - DBeQ
                - Daporinad / FK-866
                - Vorinostat / SAHA
                - Quinidine
                - Aloxistatin / E-64d
                - HARMAN

  # Configure loader
  loader_factory:
    num_workers: ${NUM_WORKERS}

trainer:
  min_epochs: 2
  max_epochs: 100
  gradient_clip_val: 0.5
  log_every_n_steps: 5

callbacks:
  model_checkpoint:
    monitor: val/acc
    mode: max
    save_top_k: 1
  early_stopping:
    monitor: val/acc
    mode: max
    patience: 12

logger:
  tensorboard:
    name: ${concat:${tags}}
  csv:
    name: ${concat:${tags}}

test: true


